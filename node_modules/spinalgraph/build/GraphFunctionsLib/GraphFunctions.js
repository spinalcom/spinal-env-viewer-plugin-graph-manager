"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.exportGraph = exportGraph;
exports.importGraph = exports.initDummyJsonGraph = void 0;

require("spinal-core-connectorjs");

var _SpinalRelationFactory = require("../Relations/SpinalRelationFactory");

var _SpinalNode = _interopRequireDefault(require("../Nodes/SpinalNode"));

var _SpinalGraph = _interopRequireDefault(require("../Nodes/SpinalGraph"));

var _SpinalContext = _interopRequireDefault(require("../Nodes/SpinalContext"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

const JSON_RELATIONS_NAME = "relation";
const JSON_NODES_INFO_NAME = "nodes_info";
const JSON_STARTING_NODE_NAME = "starting_node";

function exportGraph(_x, _x2) {
  return _exportGraph.apply(this, arguments);
}

function _exportGraph() {
  _exportGraph = _asyncToGenerator(function* (startingNode, json) {
    const startingNodeId = startingNode.getId();

    const relationMapsToJson = (relationType, relationMap, json) => {
      relationMap.forEach(relation => {
        const childrenIds = relation.getChildrenIds();

        for (let i = 0; i < childrenIds.length; i++) {
          json[relationType].push({
            from: startingNodeId,
            relationName: relation.name,
            to: childrenIds[i]
          });
        }
      });
    };

    const initJSON = () => {
      if (!json.hasOwnProperty(JSON_NODES_INFO_NAME) && !json.hasOwnProperty(JSON_RELATIONS_NAME)) {
        json[JSON_NODES_INFO_NAME] = [];
        json[JSON_RELATIONS_NAME] = {
          SPINAL_RELATION_TYPE: [],
          SPINAL_RELATION_LST_PTR_TYPE: [],
          SPINAL_RELATION_PTR_LST_TYPE: []
        };
        json[JSON_STARTING_NODE_NAME] = startingNode.info.id;
      }
    };

    initJSON();

    if (!json[JSON_NODES_INFO_NAME].includes(startingNode.info)) {
      json[JSON_NODES_INFO_NAME].push(startingNode.info);
      const relationJson = {};
      relationMapsToJson(_SpinalRelationFactory.SPINAL_RELATION_TYPE, startingNode.relationListTypeSpinalRelation, relationJson);
      relationMapsToJson(_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE, startingNode.relationListTypeSpinalRelationLstPtr, relationJson);
      relationMapsToJson(_SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE, startingNode.relationListTypeSpinalRelationPtrLst, relationJson);
      json[JSON_RELATIONS_NAME][startingNodeId] = relationJson;
      const children = yield startingNode.getChildren([]);

      for (let i = 0; i < children.length; i++) {
        yield exportGraph(children[i], json);
      }

      return json;
    } else {
      return "undefined";
    }
  });
  return _exportGraph.apply(this, arguments);
}

;

const importGraph = json => {
  const nodes = new Map();

  if (!json.hasOwnProperty(JSON_NODES_INFO_NAME) || !json.hasOwnProperty(JSON_RELATIONS_NAME) || !json.hasOwnProperty(JSON_STARTING_NODE_NAME)) {
    throw new Error("Cannot import Graph Json Malformed");
  }

  const createNodeFromInfo = info => {
    let node;

    switch (info.type) {
      case "SpinalGraph":
        node = new _SpinalGraph.default();
        break;

      case "SpinalContext":
        node = new _SpinalContext.default();
        break;

      default:
        node = new _SpinalNode.default();
        break;
    }

    node.info = info;
    return node;
  };

  const addChildrenToNode = json => {
    if (json[JSON_RELATIONS_NAME].hasOwnProperty(_SpinalRelationFactory.SPINAL_RELATION_TYPE)) json[JSON_RELATIONS_NAME][_SpinalRelationFactory.SPINAL_RELATION_TYPE].forEach(relation => {
      let node;

      if (nodes.has(relation.from) && nodes.has(relation.to)) {
        node = nodes.get(relation.from);
        node.addChild(nodes.get(relation.to), relation.relationName, _SpinalRelationFactory.SPINAL_RELATION_TYPE);
      }
    });
    if (json[JSON_RELATIONS_NAME].hasOwnProperty(_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE)) json[JSON_RELATIONS_NAME][_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].forEach(relation => {
      let node;

      if (nodes.has(relation.from) && nodes.has(relation.to)) {
        node = nodes.get(relation.from);
        node.addChild(nodes.get(relation.to), relation.relationName, _SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE);
      }
    });
    if (json[JSON_RELATIONS_NAME].hasOwnProperty(_SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE)) json[JSON_RELATIONS_NAME][_SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE].forEach(relation => {
      let node;

      if (nodes.has(relation.from) && nodes.has(relation.to)) {
        node = nodes.get(relation.from);
        node.addChild(nodes.get(relation.to), relation.relationName, _SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE);
      }
    });
  }; //Create a node for each info contain in json[JSON_NODES_INFO_NAME]


  json[JSON_NODES_INFO_NAME].forEach(info => {
    const node = createNodeFromInfo(info);
    nodes.set(node.info.id.toString(), node);
  });
  addChildrenToNode(json);
  return nodes;
};

exports.importGraph = importGraph;

const initDummyJsonGraph = () => {
  const jsonGraph = {};
  const relation = {};
  const floorsChildren = {
    7: {
      rooms: [11, 12],
      equipment: [5, 6]
    },
    8: {
      rooms: [13, 14],
      equipment: [9, 10]
    }
  };
  const roomChildren = {
    11: {
      ref: 15,
      equipment: [16]
    },
    12: {
      equipment: [17]
    },
    13: {
      equipment: [18]
    },
    14: {
      equipment: [19]
    }
  };

  const initJSON = () => {
    jsonGraph[JSON_NODES_INFO_NAME] = [];
    jsonGraph[JSON_RELATIONS_NAME] = {};
    jsonGraph[JSON_STARTING_NODE_NAME] = "";
  };

  const initRelation = () => {
    relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE] = [];
    relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE] = [];
    relation[_SpinalRelationFactory.SPINAL_RELATION_PTR_LST_TYPE] = [];
  };

  const initGraphRelation = () => {
    relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].push({
      from: 1,
      relationName: "hasContext",
      to: 2
    });
  };

  const initContextRelation = () => {
    relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
      fom: 2,
      relationName: "hasBuilding",
      to: 3
    });
  };

  const initBuildingRelation = () => {
    relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
      from: 3,
      relationName: "buildingHasFloor",
      to: 7
    });

    relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
      from: 3,
      relationName: "buildingHasFloor",
      to: 7
    });

    relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].push({
      from: 3,
      relationName: "buildingHasEquipment",
      to: 4
    });
  };

  const initFloorRelation = id => {
    const floorInfo = floorsChildren[id];

    for (let i = 0; i < floorInfo["rooms".length]; i++) relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
      from: id,
      relationName: "floorHasRoom",
      to: floorInfo["rooms"][i]
    });

    for (let i = 0; i < floorInfo["equipment"].length; i++) {
      relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].push({
        from: id,
        relationName: "FloorHasEquipment",
        to: floorInfo["equipment"][i]
      });
    }
  };

  const initRoomRelation = id => {
    const roomInfo = roomChildren[id];

    if (roomInfo.hasOwnProperty("ref")) {
      relation[_SpinalRelationFactory.SPINAL_RELATION_TYPE].push({
        from: id,
        relationName: "HasReference",
        to: roomInfo["ref"]
      });
    }

    roomInfo["equipment"].forEach(equipmentId => {
      relation[_SpinalRelationFactory.SPINAL_RELATION_LST_PTR_TYPE].push({
        from: id,
        relationName: "RoomHasEquipment",
        to: equipmentId
      });
    });
  };

  const createNodes = () => {
    jsonGraph[JSON_STARTING_NODE_NAME] = 1;
    jsonGraph[JSON_NODES_INFO_NAME].push({
      type: "SpinalGraph",
      id: 1
    });
    jsonGraph[JSON_NODES_INFO_NAME].push({
      type: "SpinalContext",
      id: 2
    });

    for (let i = 3; i < 20; i++) {
      jsonGraph[JSON_NODES_INFO_NAME].push({
        type: "SpinalNode",
        id: i
      });
    }
  };

  const createRelation = () => {
    initRelation();
    initGraphRelation();
    initContextRelation();
    initBuildingRelation();

    for (let id in floorsChildren) {
      if (floorsChildren.hasOwnProperty(id)) {
        initFloorRelation(id);
      }
    }

    for (let id in roomChildren) {
      if (roomChildren.hasOwnProperty(id)) {
        initRoomRelation(id);
      }
    }
  };

  initJSON();
  createNodes();
  createRelation();
  jsonGraph[JSON_RELATIONS_NAME] = relation;
  return jsonGraph;
};

exports.initDummyJsonGraph = initDummyJsonGraph;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9HcmFwaEZ1bmN0aW9uc0xpYi9HcmFwaEZ1bmN0aW9ucy5qcyJdLCJuYW1lcyI6WyJKU09OX1JFTEFUSU9OU19OQU1FIiwiSlNPTl9OT0RFU19JTkZPX05BTUUiLCJKU09OX1NUQVJUSU5HX05PREVfTkFNRSIsImV4cG9ydEdyYXBoIiwic3RhcnRpbmdOb2RlIiwianNvbiIsInN0YXJ0aW5nTm9kZUlkIiwiZ2V0SWQiLCJyZWxhdGlvbk1hcHNUb0pzb24iLCJyZWxhdGlvblR5cGUiLCJyZWxhdGlvbk1hcCIsImZvckVhY2giLCJyZWxhdGlvbiIsImNoaWxkcmVuSWRzIiwiZ2V0Q2hpbGRyZW5JZHMiLCJpIiwibGVuZ3RoIiwicHVzaCIsImZyb20iLCJyZWxhdGlvbk5hbWUiLCJuYW1lIiwidG8iLCJpbml0SlNPTiIsImhhc093blByb3BlcnR5IiwiU1BJTkFMX1JFTEFUSU9OX1RZUEUiLCJTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFIiwiU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSIsImluZm8iLCJpZCIsImluY2x1ZGVzIiwicmVsYXRpb25Kc29uIiwicmVsYXRpb25MaXN0VHlwZVNwaW5hbFJlbGF0aW9uIiwicmVsYXRpb25MaXN0VHlwZVNwaW5hbFJlbGF0aW9uTHN0UHRyIiwicmVsYXRpb25MaXN0VHlwZVNwaW5hbFJlbGF0aW9uUHRyTHN0IiwiY2hpbGRyZW4iLCJnZXRDaGlsZHJlbiIsImltcG9ydEdyYXBoIiwibm9kZXMiLCJNYXAiLCJFcnJvciIsImNyZWF0ZU5vZGVGcm9tSW5mbyIsIm5vZGUiLCJ0eXBlIiwiU3BpbmFsR3JhcGgiLCJTcGluYWxDb250ZXh0IiwiU3BpbmFsTm9kZSIsImFkZENoaWxkcmVuVG9Ob2RlIiwiaGFzIiwiZ2V0IiwiYWRkQ2hpbGQiLCJzZXQiLCJ0b1N0cmluZyIsImluaXREdW1teUpzb25HcmFwaCIsImpzb25HcmFwaCIsImZsb29yc0NoaWxkcmVuIiwicm9vbXMiLCJlcXVpcG1lbnQiLCJyb29tQ2hpbGRyZW4iLCJyZWYiLCJpbml0UmVsYXRpb24iLCJpbml0R3JhcGhSZWxhdGlvbiIsImluaXRDb250ZXh0UmVsYXRpb24iLCJmb20iLCJpbml0QnVpbGRpbmdSZWxhdGlvbiIsImluaXRGbG9vclJlbGF0aW9uIiwiZmxvb3JJbmZvIiwiaW5pdFJvb21SZWxhdGlvbiIsInJvb21JbmZvIiwiZXF1aXBtZW50SWQiLCJjcmVhdGVOb2RlcyIsImNyZWF0ZVJlbGF0aW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQU9BOztBQUVBOztBQUtBOztBQUNBOztBQUNBOzs7Ozs7OztBQUVBLE1BQU1BLG1CQUFtQixHQUFHLFVBQTVCO0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcsWUFBN0I7QUFDQSxNQUFNQyx1QkFBdUIsR0FBRyxlQUFoQzs7U0FFZUMsVzs7Ozs7bUNBQWYsV0FBMkJDLFlBQTNCLEVBQXlDQyxJQUF6QyxFQUErQztBQUUzQyxVQUFNQyxjQUFjLEdBQUdGLFlBQVksQ0FBQ0csS0FBYixFQUF2Qjs7QUFFQSxVQUFNQyxrQkFBa0IsR0FBRyxDQUFDQyxZQUFELEVBQWVDLFdBQWYsRUFBNEJMLElBQTVCLEtBQXFDO0FBQzVESyxNQUFBQSxXQUFXLENBQUNDLE9BQVosQ0FBcUJDLFFBQUQsSUFBYztBQUU5QixjQUFNQyxXQUFXLEdBQUdELFFBQVEsQ0FBQ0UsY0FBVCxFQUFwQjs7QUFFQSxhQUFLLElBQUlDLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdGLFdBQVcsQ0FBQ0csTUFBaEMsRUFBd0NELENBQUMsRUFBekMsRUFBNkM7QUFDekNWLFVBQUFBLElBQUksQ0FBQ0ksWUFBRCxDQUFKLENBQW1CUSxJQUFuQixDQUF3QjtBQUFFQyxZQUFBQSxJQUFJLEVBQUVaLGNBQVI7QUFBd0JhLFlBQUFBLFlBQVksRUFBRVAsUUFBUSxDQUFDUSxJQUEvQztBQUFxREMsWUFBQUEsRUFBRSxFQUFFUixXQUFXLENBQUNFLENBQUQ7QUFBcEUsV0FBeEI7QUFDSDtBQUVKLE9BUkQ7QUFTSCxLQVZE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QUFDakJDLElBQUFBLG1CQUFtQjtBQUNuQkUsSUFBQUEsb0JBQW9COztBQUNwQixTQUFLLElBQUluQyxFQUFULElBQWUwQixjQUFmLEVBQStCO0FBQzNCLFVBQUlBLGNBQWMsQ0FBQy9CLGNBQWYsQ0FBOEJLLEVBQTlCLENBQUosRUFBdUM7QUFDbkNvQyxRQUFBQSxpQkFBaUIsQ0FBQ3BDLEVBQUQsQ0FBakI7QUFDSDtBQUNKOztBQUVELFNBQUssSUFBSUEsRUFBVCxJQUFlNkIsWUFBZixFQUE2QjtBQUN6QixVQUFJQSxZQUFZLENBQUNsQyxjQUFiLENBQTRCSyxFQUE1QixDQUFKLEVBQXFDO0FBQ2pDc0MsUUFBQUEsZ0JBQWdCLENBQUN0QyxFQUFELENBQWhCO0FBQ0g7QUFDSjtBQUNKLEdBaEJEOztBQWtCQU4sRUFBQUEsUUFBUTtBQUNSK0MsRUFBQUEsV0FBVztBQUNYQyxFQUFBQSxjQUFjO0FBQ2RqQixFQUFBQSxTQUFTLENBQUNyRCxtQkFBRCxDQUFULEdBQWlDWSxRQUFqQztBQUNBLFNBQU95QyxTQUFQO0FBRUgsQ0FsSEQiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqXG4gKiBUaGlzIGZpbGUgY29udGFpbiB1c2VmdWwgZnVuY3Rpb25zIHRoYXQgaGVscCBtYW5pcHVsYXRlIHRoZSBncmFwaCBzdHJ1Y3R1cmVcbiAqIHN1Y2ggYXMgYW4gZ2VuZXJpYyBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgRGVlcCBGaXJzdCBTZWFyY2ggYW5kIEJyZWFkdGggRmlyc3QgU2VhcmNoIGFsZ29yaXRobS5cbiAqXG4gKi9cblxuaW1wb3J0IFwic3BpbmFsLWNvcmUtY29ubmVjdG9yanNcIjtcblxuaW1wb3J0IHtcbiAgICBTUElOQUxfUkVMQVRJT05fVFlQRSxcbiAgICBTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFLFxuICAgIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUsXG59IGZyb20gXCIuLi9SZWxhdGlvbnMvU3BpbmFsUmVsYXRpb25GYWN0b3J5XCJcbmltcG9ydCBTcGluYWxOb2RlIGZyb20gXCIuLi9Ob2Rlcy9TcGluYWxOb2RlXCI7XG5pbXBvcnQgU3BpbmFsR3JhcGggZnJvbSBcIi4uL05vZGVzL1NwaW5hbEdyYXBoXCI7XG5pbXBvcnQgU3BpbmFsQ29udGV4dCBmcm9tIFwiLi4vTm9kZXMvU3BpbmFsQ29udGV4dFwiO1xuXG5jb25zdCBKU09OX1JFTEFUSU9OU19OQU1FID0gXCJyZWxhdGlvblwiO1xuY29uc3QgSlNPTl9OT0RFU19JTkZPX05BTUUgPSBcIm5vZGVzX2luZm9cIjtcbmNvbnN0IEpTT05fU1RBUlRJTkdfTk9ERV9OQU1FID0gXCJzdGFydGluZ19ub2RlXCI7XG5cbmFzeW5jIGZ1bmN0aW9uIGV4cG9ydEdyYXBoKHN0YXJ0aW5nTm9kZSwganNvbikge1xuXG4gICAgY29uc3Qgc3RhcnRpbmdOb2RlSWQgPSBzdGFydGluZ05vZGUuZ2V0SWQoKTtcblxuICAgIGNvbnN0IHJlbGF0aW9uTWFwc1RvSnNvbiA9IChyZWxhdGlvblR5cGUsIHJlbGF0aW9uTWFwLCBqc29uKSA9PiB7XG4gICAgICAgIHJlbGF0aW9uTWFwLmZvckVhY2goKHJlbGF0aW9uKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGNoaWxkcmVuSWRzID0gcmVsYXRpb24uZ2V0Q2hpbGRyZW5JZHMoKTtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbklkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGpzb25bcmVsYXRpb25UeXBlXS5wdXNoKHsgZnJvbTogc3RhcnRpbmdOb2RlSWQsIHJlbGF0aW9uTmFtZTogcmVsYXRpb24ubmFtZSwgdG86IGNoaWxkcmVuSWRzW2ldIH0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRKU09OID0gKCkgPT4ge1xuICAgICAgICBpZiAoIWpzb24uaGFzT3duUHJvcGVydHkoSlNPTl9OT0RFU19JTkZPX05BTUUpICYmICFqc29uLmhhc093blByb3BlcnR5KEpTT05fUkVMQVRJT05TX05BTUUpKSB7XG5cbiAgICAgICAgICAgIGpzb25bSlNPTl9OT0RFU19JTkZPX05BTUVdID0gW107XG5cbiAgICAgICAgICAgIGpzb25bSlNPTl9SRUxBVElPTlNfTkFNRV0gPSB7XG4gICAgICAgICAgICAgICAgU1BJTkFMX1JFTEFUSU9OX1RZUEU6IFtdLFxuICAgICAgICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEU6IFtdLFxuICAgICAgICAgICAgICAgIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEU6IFtdXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBqc29uW0pTT05fU1RBUlRJTkdfTk9ERV9OQU1FXSA9IHN0YXJ0aW5nTm9kZS5pbmZvLmlkO1xuICAgICAgICB9XG4gICAgfTtcblxuXG4gICAgaW5pdEpTT04oKTtcblxuICAgIGlmICghanNvbltKU09OX05PREVTX0lORk9fTkFNRV0uaW5jbHVkZXMoc3RhcnRpbmdOb2RlLmluZm8pKSB7XG5cblxuICAgICAgICBqc29uW0pTT05fTk9ERVNfSU5GT19OQU1FXS5wdXNoKHN0YXJ0aW5nTm9kZS5pbmZvKTtcbiAgICAgICAgY29uc3QgcmVsYXRpb25Kc29uID0ge307XG4gICAgICAgIHJlbGF0aW9uTWFwc1RvSnNvbihTUElOQUxfUkVMQVRJT05fVFlQRSwgc3RhcnRpbmdOb2RlLnJlbGF0aW9uTGlzdFR5cGVTcGluYWxSZWxhdGlvbiwgcmVsYXRpb25Kc29uKTtcbiAgICAgICAgcmVsYXRpb25NYXBzVG9Kc29uKFNQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEUsIHN0YXJ0aW5nTm9kZS5yZWxhdGlvbkxpc3RUeXBlU3BpbmFsUmVsYXRpb25Mc3RQdHIsIHJlbGF0aW9uSnNvbik7XG4gICAgICAgIHJlbGF0aW9uTWFwc1RvSnNvbihTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFLCBzdGFydGluZ05vZGUucmVsYXRpb25MaXN0VHlwZVNwaW5hbFJlbGF0aW9uUHRyTHN0LCByZWxhdGlvbkpzb24pO1xuICAgICAgICBqc29uW0pTT05fUkVMQVRJT05TX05BTUVdW3N0YXJ0aW5nTm9kZUlkXSA9IHJlbGF0aW9uSnNvbjtcblxuXG4gICAgICAgIGNvbnN0IGNoaWxkcmVuID0gYXdhaXQgc3RhcnRpbmdOb2RlLmdldENoaWxkcmVuKFtdKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgYXdhaXQgZXhwb3J0R3JhcGgoY2hpbGRyZW5baV0sIGpzb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGpzb247XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4gXCJ1bmRlZmluZWRcIlxuICAgIH1cbn07XG5cblxuY29uc3QgaW1wb3J0R3JhcGggPSAoanNvbikgPT4ge1xuXG4gICAgY29uc3Qgbm9kZXMgPSBuZXcgTWFwKCk7XG4gICAgaWYgKCFqc29uLmhhc093blByb3BlcnR5KEpTT05fTk9ERVNfSU5GT19OQU1FKSB8fCAhanNvbi5oYXNPd25Qcm9wZXJ0eShKU09OX1JFTEFUSU9OU19OQU1FKSB8fCAhanNvbi5oYXNPd25Qcm9wZXJ0eShKU09OX1NUQVJUSU5HX05PREVfTkFNRSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGltcG9ydCBHcmFwaCBKc29uIE1hbGZvcm1lZFwiKVxuICAgIH1cblxuICAgIGNvbnN0IGNyZWF0ZU5vZGVGcm9tSW5mbyA9IChpbmZvKSA9PiB7XG4gICAgICAgIGxldCBub2RlO1xuICAgICAgICBzd2l0Y2ggKGluZm8udHlwZSkge1xuICAgICAgICAgICAgY2FzZSBcIlNwaW5hbEdyYXBoXCI6XG4gICAgICAgICAgICAgICAgbm9kZSA9IG5ldyBTcGluYWxHcmFwaCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcIlNwaW5hbENvbnRleHRcIjpcbiAgICAgICAgICAgICAgICBub2RlID0gbmV3IFNwaW5hbENvbnRleHQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgbm9kZSA9IG5ldyBTcGluYWxOb2RlKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBub2RlLmluZm8gPSBpbmZvO1xuXG4gICAgICAgIHJldHVybiBub2RlO1xuICAgIH07XG5cbiAgICBjb25zdCBhZGRDaGlsZHJlblRvTm9kZSA9IChqc29uKSA9PiB7XG4gICAgICAgIGlmIChqc29uW0pTT05fUkVMQVRJT05TX05BTUVdLmhhc093blByb3BlcnR5KFNQSU5BTF9SRUxBVElPTl9UWVBFKSlcbiAgICAgICAgICAgIGpzb25bSlNPTl9SRUxBVElPTlNfTkFNRV1bU1BJTkFMX1JFTEFUSU9OX1RZUEVdLmZvckVhY2gocmVsYXRpb24gPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IG5vZGU7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGVzLmhhcyhyZWxhdGlvbi5mcm9tKSAmJiBub2Rlcy5oYXMocmVsYXRpb24udG8pKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2Rlcy5nZXQocmVsYXRpb24uZnJvbSk7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuYWRkQ2hpbGQobm9kZXMuZ2V0KHJlbGF0aW9uLnRvKSwgcmVsYXRpb24ucmVsYXRpb25OYW1lLCBTUElOQUxfUkVMQVRJT05fVFlQRSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICBpZiAoanNvbltKU09OX1JFTEFUSU9OU19OQU1FXS5oYXNPd25Qcm9wZXJ0eShTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFKSlcbiAgICAgICAgICAgIGpzb25bSlNPTl9SRUxBVElPTlNfTkFNRV1bU1BJTkFMX1JFTEFUSU9OX0xTVF9QVFJfVFlQRV0uZm9yRWFjaChyZWxhdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IG5vZGU7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGVzLmhhcyhyZWxhdGlvbi5mcm9tKSAmJiBub2Rlcy5oYXMocmVsYXRpb24udG8pKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2Rlcy5nZXQocmVsYXRpb24uZnJvbSk7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuYWRkQ2hpbGQobm9kZXMuZ2V0KHJlbGF0aW9uLnRvKSwgcmVsYXRpb24ucmVsYXRpb25OYW1lLCBTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChqc29uW0pTT05fUkVMQVRJT05TX05BTUVdLmhhc093blByb3BlcnR5KFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpKVxuICAgICAgICAgICAganNvbltKU09OX1JFTEFUSU9OU19OQU1FXVtTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFXS5mb3JFYWNoKHJlbGF0aW9uID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbm9kZTtcbiAgICAgICAgICAgICAgICBpZiAobm9kZXMuaGFzKHJlbGF0aW9uLmZyb20pICYmIG5vZGVzLmhhcyhyZWxhdGlvbi50bykpIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGVzLmdldChyZWxhdGlvbi5mcm9tKTtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5hZGRDaGlsZChub2Rlcy5nZXQocmVsYXRpb24udG8pLCByZWxhdGlvbi5yZWxhdGlvbk5hbWUsIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG5cbiAgICB9O1xuICAgIC8vQ3JlYXRlIGEgbm9kZSBmb3IgZWFjaCBpbmZvIGNvbnRhaW4gaW4ganNvbltKU09OX05PREVTX0lORk9fTkFNRV1cbiAgICBqc29uW0pTT05fTk9ERVNfSU5GT19OQU1FXS5mb3JFYWNoKGluZm8gPT4ge1xuXG4gICAgICAgIGNvbnN0IG5vZGUgPSBjcmVhdGVOb2RlRnJvbUluZm8oaW5mbyk7XG5cbiAgICAgICAgbm9kZXMuc2V0KG5vZGUuaW5mby5pZC50b1N0cmluZygpLCBub2RlKTtcblxuICAgIH0pO1xuICAgIGFkZENoaWxkcmVuVG9Ob2RlKGpzb24pO1xuXG4gICAgcmV0dXJuIG5vZGVzO1xufTtcblxuXG5jb25zdCBpbml0RHVtbXlKc29uR3JhcGggPSAoKSA9PiB7XG5cbiAgICBjb25zdCBqc29uR3JhcGggPSB7fTtcbiAgICBjb25zdCByZWxhdGlvbiA9IHt9O1xuICAgIGNvbnN0IGZsb29yc0NoaWxkcmVuID0ge1xuICAgICAgICA3OiB7IHJvb21zOiBbMTEsIDEyXSwgZXF1aXBtZW50OiBbNSwgNl0gfSxcbiAgICAgICAgODogeyByb29tczogWzEzLCAxNF0sIGVxdWlwbWVudDogWzksIDEwXSB9XG4gICAgfTtcblxuICAgIGNvbnN0IHJvb21DaGlsZHJlbiA9IHtcbiAgICAgICAgMTE6IHtcbiAgICAgICAgICAgIHJlZjogMTUsXG4gICAgICAgICAgICBlcXVpcG1lbnQ6IFsxNl1cbiAgICAgICAgfSxcbiAgICAgICAgMTI6IHsgZXF1aXBtZW50OiBbMTddIH0sXG4gICAgICAgIDEzOiB7IGVxdWlwbWVudDogWzE4XSB9LFxuICAgICAgICAxNDogeyBlcXVpcG1lbnQ6IFsxOV0gfVxuICAgIH07XG5cbiAgICBjb25zdCBpbml0SlNPTiA9ICgpID0+IHtcbiAgICAgICAganNvbkdyYXBoW0pTT05fTk9ERVNfSU5GT19OQU1FXSA9IFtdO1xuICAgICAgICBqc29uR3JhcGhbSlNPTl9SRUxBVElPTlNfTkFNRV0gPSB7fTtcbiAgICAgICAganNvbkdyYXBoW0pTT05fU1RBUlRJTkdfTk9ERV9OQU1FXSA9IFwiXCI7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRSZWxhdGlvbiA9ICgpID0+IHtcbiAgICAgICAgcmVsYXRpb25bU1BJTkFMX1JFTEFUSU9OX1RZUEVdID0gW107XG4gICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEVdID0gW107XG4gICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEVdID0gW107XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRHcmFwaFJlbGF0aW9uID0gKCkgPT4ge1xuICAgICAgICByZWxhdGlvbltTUElOQUxfUkVMQVRJT05fTFNUX1BUUl9UWVBFXS5wdXNoKHsgZnJvbTogMSwgcmVsYXRpb25OYW1lOiBcImhhc0NvbnRleHRcIiwgdG86IDIgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRDb250ZXh0UmVsYXRpb24gPSAoKSA9PiB7XG4gICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9UWVBFXS5wdXNoKHsgZm9tOiAyLCByZWxhdGlvbk5hbWU6IFwiaGFzQnVpbGRpbmdcIiwgdG86IDMgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRCdWlsZGluZ1JlbGF0aW9uID0gKCkgPT4ge1xuICAgICAgICByZWxhdGlvbltTUElOQUxfUkVMQVRJT05fVFlQRV0ucHVzaCh7IGZyb206IDMsIHJlbGF0aW9uTmFtZTogXCJidWlsZGluZ0hhc0Zsb29yXCIsIHRvOiA3LCB9KTtcbiAgICAgICAgcmVsYXRpb25bU1BJTkFMX1JFTEFUSU9OX1RZUEVdLnB1c2goeyBmcm9tOiAzLCByZWxhdGlvbk5hbWU6IFwiYnVpbGRpbmdIYXNGbG9vclwiLCB0bzogNywgfSk7XG4gICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEVdLnB1c2goeyBmcm9tOiAzLCByZWxhdGlvbk5hbWU6IFwiYnVpbGRpbmdIYXNFcXVpcG1lbnRcIiwgdG86IDQgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRGbG9vclJlbGF0aW9uID0gKGlkKSA9PiB7XG4gICAgICAgIGNvbnN0IGZsb29ySW5mbyA9IGZsb29yc0NoaWxkcmVuW2lkXTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmbG9vckluZm9bXCJyb29tc1wiLmxlbmd0aF07IGkrKylcbiAgICAgICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9UWVBFXS5wdXNoKHtcbiAgICAgICAgICAgICAgICBmcm9tOiBpZCxcbiAgICAgICAgICAgICAgICByZWxhdGlvbk5hbWU6IFwiZmxvb3JIYXNSb29tXCIsXG4gICAgICAgICAgICAgICAgdG86IGZsb29ySW5mb1tcInJvb21zXCJdW2ldXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmbG9vckluZm9bXCJlcXVpcG1lbnRcIl0ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9MU1RfUFRSX1RZUEVdLnB1c2goe1xuICAgICAgICAgICAgICAgIGZyb206IGlkLFxuICAgICAgICAgICAgICAgIHJlbGF0aW9uTmFtZTogXCJGbG9vckhhc0VxdWlwbWVudFwiLFxuICAgICAgICAgICAgICAgIHRvOiBmbG9vckluZm9bXCJlcXVpcG1lbnRcIl1baV1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGluaXRSb29tUmVsYXRpb24gPSAoaWQpID0+IHtcbiAgICAgICAgY29uc3Qgcm9vbUluZm8gPSByb29tQ2hpbGRyZW5baWRdO1xuICAgICAgICBpZiAocm9vbUluZm8uaGFzT3duUHJvcGVydHkoXCJyZWZcIikpIHtcbiAgICAgICAgICAgIHJlbGF0aW9uW1NQSU5BTF9SRUxBVElPTl9UWVBFXS5wdXNoKHtcbiAgICAgICAgICAgICAgICBmcm9tOiBpZCxcbiAgICAgICAgICAgICAgICByZWxhdGlvbk5hbWU6IFwiSGFzUmVmZXJlbmNlXCIsXG4gICAgICAgICAgICAgICAgdG86IHJvb21JbmZvW1wicmVmXCJdXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJvb21JbmZvW1wiZXF1aXBtZW50XCJdLmZvckVhY2goZXF1aXBtZW50SWQgPT4ge1xuICAgICAgICAgICAgcmVsYXRpb25bU1BJTkFMX1JFTEFUSU9OX0xTVF9QVFJfVFlQRV0ucHVzaCh7XG4gICAgICAgICAgICAgICAgZnJvbTogaWQsXG4gICAgICAgICAgICAgICAgcmVsYXRpb25OYW1lOiBcIlJvb21IYXNFcXVpcG1lbnRcIixcbiAgICAgICAgICAgICAgICB0bzogZXF1aXBtZW50SWRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgIH07XG5cbiAgICBjb25zdCBjcmVhdGVOb2RlcyA9ICgpID0+IHtcbiAgICAgICAganNvbkdyYXBoW0pTT05fU1RBUlRJTkdfTk9ERV9OQU1FXSA9IDE7XG4gICAgICAgIGpzb25HcmFwaFtKU09OX05PREVTX0lORk9fTkFNRV0ucHVzaCh7IHR5cGU6IFwiU3BpbmFsR3JhcGhcIiwgaWQ6IDEgfSk7XG4gICAgICAgIGpzb25HcmFwaFtKU09OX05PREVTX0lORk9fTkFNRV0ucHVzaCh7IHR5cGU6IFwiU3BpbmFsQ29udGV4dFwiLCBpZDogMiB9KTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDM7IGkgPCAyMDsgaSsrKSB7XG4gICAgICAgICAgICBqc29uR3JhcGhbSlNPTl9OT0RFU19JTkZPX05BTUVdLnB1c2goeyB0eXBlOiBcIlNwaW5hbE5vZGVcIiwgaWQ6IGkgfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgY3JlYXRlUmVsYXRpb24gPSAoKSA9PiB7XG4gICAgICAgIGluaXRSZWxhdGlvbigpO1xuICAgICAgICBpbml0R3JhcGhSZWxhdGlvbigpO1xuICAgICAgICBpbml0Q29udGV4dFJlbGF0aW9uKCk7XG4gICAgICAgIGluaXRCdWlsZGluZ1JlbGF0aW9uKCk7XG4gICAgICAgIGZvciAobGV0IGlkIGluIGZsb29yc0NoaWxkcmVuKSB7XG4gICAgICAgICAgICBpZiAoZmxvb3JzQ2hpbGRyZW4uaGFzT3duUHJvcGVydHkoaWQpKSB7XG4gICAgICAgICAgICAgICAgaW5pdEZsb29yUmVsYXRpb24oaWQpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpZCBpbiByb29tQ2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGlmIChyb29tQ2hpbGRyZW4uaGFzT3duUHJvcGVydHkoaWQpKSB7XG4gICAgICAgICAgICAgICAgaW5pdFJvb21SZWxhdGlvbihpZClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBpbml0SlNPTigpO1xuICAgIGNyZWF0ZU5vZGVzKCk7XG4gICAgY3JlYXRlUmVsYXRpb24oKTtcbiAgICBqc29uR3JhcGhbSlNPTl9SRUxBVElPTlNfTkFNRV0gPSByZWxhdGlvbjtcbiAgICByZXR1cm4ganNvbkdyYXBoO1xuXG59O1xuXG5cbmV4cG9ydCB7XG4gICAgaW5pdER1bW15SnNvbkdyYXBoLFxuICAgIGltcG9ydEdyYXBoLFxuICAgIGV4cG9ydEdyYXBoXG59Il19